#+TITLE: ТЗ: Проектный контекст gptel (gptel-navigator + gptel-context)
#+AUTHOR: az / AI Assistant
#+LANGUAGE: ru
#+OPTIONS: num:nil ^:nil toc:3

* Цель
Сделать контекст GPTel «проектно‑осознанным»: у каждого проекта (project.el / projectile)
свой набор файлов и регионов, который:
- автоматически загружается при переключении между проектами;
- автоматически сохраняется при изменении контекста;
- показывается в сайдбаре GPTel Navigator.

Для буферов вне проекта используется глобальный контекст (~/.gptel-navigator).

* Термины
- «Контекст» — то, что возвращает gptel-context: файлы, буферы, регионы.
- «Проект» — корень project.el или projectile.
- «Глобальный контекст» — контекст для буферов без проекта.

* Область работ (v1, MVP)
- [x] Отображать текущее состояние контекста в сайдбаре (есть).
- [x] Хранить контекст проекта на диске: <root>/.gptel-navigator/context.el.
- [x] Хранить «глобальный» контекст: ~/.gptel-navigator/context.el.
- [x] Команда gptel-navigator-project-context-load — загрузка контекста проекта.
- [x] Команда gptel-navigator-project-context-save — сохранение контекста проекта.
- [x] Глобальный режим gptel-navigator-project-context-autoload-mode:
  - автозагрузка при входе в проект/выходе из него;
  - автосохранение после изменений контекста (add/remove/...).
- [x] Для буферов без файла региональные оверлеи не сериализуются (безопасно игнорируются).

Ограничения v1:
- Диапазоны регионов сохраняются как абсолютные позиции в файле; при значимых изменениях
  файла потребуется ручная актуализация.

* Хранение и формат
- Проектный путь: <project-root>/.gptel-navigator/context.el
- Глобальный путь: ~/.gptel-navigator/context.el

Формат (Elisp sexp, без выполнения кода):
- (:file "relative/or/absolute/path" [:mime "image/png"])
- (:buffer "relative/path" :regions ((BEG . END) ...)) — только для файловых буферов

Относительные пути — от корня проекта; глобальные — абсолютные.

* Поведение автозагрузки
- При смене активного окна/буфера определяется корень проекта.
- Если корень проекта отличается от последнего загруженного — грузим новый контекст
  из соответствующего файла.
- Если файла нет — контекст очищается (пустой), сайдбар обновляется.

* Поведение автосохранения
- На любые мутации gptel-context (add/remove/remove-all/...) записываем контекст
  в файл проекта или глобальный файл, если проекта нет.
- Включается/выключается вместе с gptel-navigator-project-context-autoload-mode.

* API/Команды
- gptel-navigator-project-context-load (&optional root)
  Загрузить контекст для проекта ROOT (или autodetect). Обновить сайдбар.
- gptel-navigator-project-context-save (&optional root)
  Сохранить текущий контекст в файл проекта или глобальный.
- gptel-navigator-project-context-autoload-mode
  Глобальный режим авто‑загрузки/сохранения; хранит последний активный корень.

* Интеграция с сайдбаром
- Сайдбар уже читает контекст через gptel-context--collect.
- При загрузке/сохранении выполняется gptel-navigator-refresh.
- При включенном gptel-navigator-auto-refresh обновление происходит автоматически
  и на событиях gptel-context.

* UX сценарии
1) Пользователь открывает проект А → контекст проекта А загружается → виден в сайдбаре.
2) Пользователь добавляет файлы/регионы в контекст → автосохранение в .gptel-navigator/.
3) Переключается в проект Б → подхватывается контекст Б.
4) Открывает одиночный файл вне проекта → используется ~/.gptel-navigator/.

* Расширения (планы v2+)
- Устойчивые регионы: стратегия «по якорям» (lineno + nearby text), diff‑reanchor.
- Миграция формата хранения в JSON для интеграций с внешними инструментами.
- Импорт/экспорт контекста, share в git (с опциональной приватностью).
- Команды управления наборами контекстов (профили/варианты) в рамках проекта.
- Тонкие политики авто‑сохранения (debounce, on-save, on-exit).
- Совместимость с удалёнными проектами/тристоронним путём (TRAMP).

* Ограничения и безопасность
- Файл — чистый sexp-данные; не выполняется (используется read, не load).
- Позиции регионов могут устаревать при редактировании файлов.
- Включение/выключение автозагрузки оставлено пользователю (minor-mode).

* Критерии приёмки (v1)
- При включённом gptel-navigator-project-context-autoload-mode
  - переключение между двумя разными проектами меняет списки в сайдбаре без перезапуска Emacs;
  - добавление/удаление контекста порождает запись в корректные файлы;
  - при отсутствии файла контекст становится пустым и это видно в сайдбаре.
- Команды gptel-navigator-project-context-load/save работают интерактивно и не падают на пустом контексте.

* Пример настройки
#+begin_src emacs-lisp
;; Включить сайдбар и автообновление
(gptel-navigator-mode 1)
(setq gptel-navigator-auto-refresh t)

;; Включить автозагрузку/сохранение проектного контекста
(gptel-navigator-project-context-autoload-mode 1)

;; Папки по умолчанию (опционально)
(setq gptel-navigator-project-dir-name ".gptel-navigator")
(setq gptel-navigator-context-file-name "context.el")
(setq gptel-navigator-global-dir "~/.gptel-navigator/")
#+end_src
