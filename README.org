#+title: Emacs Context Navigator
#+author: Peter Kosov <11111000000@email.com>
#+options: toc:t num:nil
#+toc: headlines 2

* Overview

Emacs Context Navigator is a lightweight, project‑aware context manager and sidebar for Emacs.

The idea: practice “context engineering”. Instead of keeping task state, open files, buffer selections, and notes in your head, externalize them into clear, reusable context groups per project (or globally). Switch context instantly, reduce cognitive load, and keep your focus on the work.

- View to browse items and groups, with compact controls
- Project‑aware, optional auto‑switch on buffer/project change
- One‑way integration with GPTel (push current items → GPTel)
- Async, per‑group persistence with progress and spinner
- Dired‑aware “Universal Add”, globs, and “add from text”

Repository: https://github.com/11111000000/context-navigator

* Screenshots

#+caption: Items view — your current context (enabled files, buffers, selections)
#+attr_org: :width 820
[[./context-navigator-items.png]]

#+caption: Groups view — switch, create, rename, duplicate, delete
#+attr_org: :width 820
[[./context-navigator-groups.png]]

#+caption: Transient menu — quick access to panel, groups, add, GPTel, logs
#+attr_org: :width 760
[[./context-navigator-transient.png]]

#+caption: Sidebar help — localized, column‑formatted keys
#+attr_org: :width 820
[[./context-navigator-help.png]]

* Requirements

- Emacs 29.1+ (recommended 30.1+)
- transient 0.3.0+ (for the global menu)
- Optional:
  - gptel (for one‑way push)
  - project.el or projectile (for project detection/auto‑switch)
  - all-the-icons (for icons in the sidebar; remember to install fonts)

* Installation

Not on MELPA. Use a local checkout or straight.el from GitHub.

- Local checkout + use-package (recommended)
#+begin_src emacs-lisp
(add-to-list 'load-path "/path/to/context-navigator")

(use-package context-navigator
  :commands (context-navigator-start
             context-navigator-mode
             context-navigator-view-open)
  :init
  ;; Optional, but handy: set a global key for the transient menu
  (setq context-navigator-global-key "C-c n")
  ;; Recommended defaults
  (setq context-navigator-autoload t
        context-navigator-autosave t)
  :config
  (context-navigator-mode 1))
#+end_src

- straight.el (from GitHub)
#+begin_src emacs-lisp
(use-package context-navigator
  :straight (context-navigator
             :type git
             :host github
             :repo "11111000000/context-navigator")
  :init
  (setq context-navigator-global-key "C-c n"
        context-navigator-autoload t
        context-navigator-autosave t)
  :config
  (context-navigator-mode 1))
#+end_src

Notes:
- If you don’t want a global binding, keep =context-navigator-global-key= as nil and use =M-x context-navigator-transient=.
- If you enable icons, install fonts once: =M-x all-the-icons-install-fonts=.

* Quick Start

- Enable the mode: =M-x context-navigator-mode= (or add =(context-navigator-mode 1)= to your init)
- Open the Navigator right away: =M-x context-navigator-start= (default display: buffer/magit-like; switch with M in transient)
- Press your global key, e.g., =C-c n=, then:
  - n — toggle Navigator; M — Display Mode (buffer/sidebar)
  - a — Add (universal): region/file/buffer or Dired selection
  - f — Add files by glob (from minibuffer)
  - t — Add files from text (extracts paths from region/buffer)
  - g — show groups
  - G/A — toggle push→gptel / auto‑project
  - P/C — Push now / Clear gptel
- Press ? in the sidebar for localized, column‑formatted help

* Core workflows

- Switch between task groups (project‑centric): “research”, “bug‑123”, “release”.
- Auto‑project switching: follows your current file/gptel/Dired buffers across projects.
- LLM sessions: push enabled items to GPTel on demand or automatically; return to saved groups anytime.
- Adding context:
  - “Universal Add” (from Dired/region/file/buffer)
  - Add by mask (glob)
  - Add from text (extract file‑like tokens and resolve)

* Usage — interface overview

- Sidebar
  - Items view header shows “[project: group]”; Groups view shows “[project]”.
  - Header toggles (clickable and TAB‑reachable):
    - [→]  push→gptel on/off
    - [A]  auto‑project on/off
  - Footer actions:
    - [O] Open buffers (background; shows a dynamic count; remote‑aware)
    - [∅] Close buffers (belonging to the current group)
    - [⇪] Push now (disabled when auto‑push is ON)
    - [✖] Clear group (remove all items)
    - [⌦] Clear gptel (model unaffected)
  - Indicators (green/gray) show whether an item is present in GPTel (when enabled).

- Transient menu (=C-c n= by default)
  - Quick access to panel, groups, add, GPTel toggles, and logs.

- Navigation
  - Items and groups are interactive. Use TAB/Shift‑TAB to move between toggles, actions, items, and groups.
  - Ret/Space: visit/preview. j/k or n/p: next/prev.

Examples:
- Open all context buffers for a group, then Push now to ground a GPTel chat.
- Dired: mark files and “a” (Universal Add) to collect them; if directories are included, confirm via preview.

* Key bindings (summary)

- Global (context-navigator-mode)
  - Your chosen key (e.g., C-c n) → =context-navigator-transient=

- Transient (selected)
  - Panel/Project: n (toggle sidebar), p (switch to current buffer’s project)
  - Context/Groups: g (groups list), X (unload context)
  - Actions: a (Add universal), f (Add by mask), t (Add from text), o (Open buffers)
  - GPTel: G (toggle push), A (toggle auto‑project), P (push now), C (clear gptel)
  - Logs: D (toggle logs), L (open logs), K (clear logs), V (set level), F (toggle file logging)

- Sidebar (context-navigator-view-mode)
  - RET / l: activate (visit item/open group)
  - SPC: preview (other window)
  - n/p/j/k: next/previous
  - t: toggle GPTel membership for item at point
  - d: delete (item or group, depending on view)
  - g: refresh (items or groups)
  - h: go up (toggle items ↔ groups)
  - a / r / c: add / rename / duplicate group (groups view)
  - G / A: toggle push→gptel / auto‑project
  - P / C: push now / clear gptel
  - O / o: open all context buffers (background)
  - E: clear current group
  - TAB / S-TAB: jump across toggles/actions/items/groups
  - q: quit, ?: help

Quality‑of‑life:
- =delete-other-windows= is remapped to close sidebar windows first (keeps layout).
- Optional: protect window balancing while the sidebar is visible.

* Configuration (reference tables)

Below are all public settings collected from the source, grouped by module. “Default” reflects the code defaults, not your current values.

** Core (context-navigator-core.el)

| Variable                                   | Type                      | Default                   | Description                                                                                   | Module/File                     |
|--------------------------------------------+---------------------------+---------------------------+-----------------------------------------------------------------------------------------------+----------------------------------|
| context-navigator-auto-refresh             | boolean                   | t                         | Auto refresh model/sidebar after external changes                                             | core/context-navigator-core.el   |
| context-navigator-global-key               | string or nil             | nil                       | Global key for transient (e.g., "C-c n"); nil = no binding                                    | core/context-navigator-core.el   |
| context-navigator-view-width            | integer                   | 33                        | Sidebar width in columns                                                                      | core/context-navigator-core.el   |
| context-navigator-max-filename-length      | integer                   | 64                        | Max display length for file names                                                             | core/context-navigator-core.el   |
| context-navigator-context-switch-interval  | number                    | 0.7                       | Throttle interval (s) for project auto‑switch                                                | core/context-navigator-core.el   |
| context-navigator-context-load-batch-size  | integer                   | 64                        | Batch size for async context load                                                             | core/context-navigator-core.el   |
| context-navigator-gptel-apply-batch-size   | integer                   | 20                        | Items per tick when pushing to GPTel in background                                            | core/context-navigator-core.el   |
| context-navigator-gptel-apply-batch-interval | number                  | 0.05                      | Delay (s) between GPTel apply batches                                                         | core/context-navigator-core.el   |
| context-navigator-gptel-require-visible-window | boolean                | nil                       | Defer GPTel apply until a GPTel window is visible                                             | core/context-navigator-core.el   |
| context-navigator-gptel-visible-poll-interval | number                 | 0.5                       | Poll interval (s) for GPTel visibility when deferred                                          | core/context-navigator-core.el   |
| context-navigator-autosave                 | boolean                   | t                         | Autosave group file on model refresh                                                          | core/context-navigator-core.el   |
| context-navigator-autosave-debounce        | number                    | 0.5                       | Debounce (s) for autosave                                                                     | core/context-navigator-core.el   |
| context-navigator-autoload                 | boolean                   | t                         | Autoload context on project switch                                                            | core/context-navigator-core.el   |
| context-navigator-default-push-to-gptel    | boolean                   | nil                       | Initial session state: push to GPTel                                                          | core/context-navigator-core.el   |
| context-navigator-default-auto-project-switch | boolean                | nil                       | Initial session state: auto‑project switch                                                    | core/context-navigator-core.el   |
| context-navigator-dir-name                 | string                    | ".context"                | Project subdir for context files                                                              | core/context-navigator-core.el   |
| context-navigator-context-file-name        | string                    | "context.el"              | Legacy single‑file name (still used for compatibility paths)                                  | core/context-navigator-core.el   |
| context-navigator-global-dir               | directory                 | ~/.context                | Global context directory                                                                      | core/context-navigator-core.el   |
| context-navigator-create-default-group-file| boolean                   | t                         | Ensure default group file exists on first use                                                 | core/context-navigator-core.el   |
| context-navigator-protect-sidebar-windows  | boolean                   | t                         | Protect sidebar from window‑balancing (skip balance while visible)                            | core/context-navigator-core.el   |

Constants:
| Variable                          | Type     | Default | Description                                | Module/File                    |
|-----------------------------------+----------+---------+--------------------------------------------+--------------------------------|
| context-navigator-persist-version | constant |       3 | Persist format version used across modules | core/context-navigator-core.el |

** Sidebar (context-navigator-view.el)

| Variable                                         | Type            | Default | Description                                                | Module/File                       |                                             |                                   |
|--------------------------------------------------+-----------------+---------+------------------------------------------------------------+-----------------------------------+---------------------------------------------+-----------------------------------|
| context-navigator-auto-open-groups-on-error      | boolean         | t       | Auto‑open groups list when a group fails to load           | sidebar/context-navigator-view.el |                                             |                                   |
| context-navigator-highlight-active-group         | boolean         | t       | Highlight active group in groups list                      | sidebar/context-navigator-view.el |                                             |                                   |
| context-navigator-controls-style                 | choice (auto    | icons   | text)                                                      | text                              | Labels style for toggles/actions            | sidebar/context-navigator-view.el |
| context-navigator-openable-count-ttl             | number          | 0.3     | Cache TTL (s) for openable counter                         | sidebar/context-navigator-view.el |                                             |                                   |
| context-navigator-openable-soft-cap              | integer         | 100     | Soft cap for counting openable buffers                     | sidebar/context-navigator-view.el |                                             |                                   |
| context-navigator-openable-remote-mode           | choice (lazy    | strict  | off)                                                       | lazy                              | How to treat remote files in “Open buffers” | sidebar/context-navigator-view.el |
| context-navigator-gptel-indicator-poll-interval  | number          | 1.0     | Polling interval (s) for GPTel indicators (0 to disable)   | sidebar/context-navigator-view.el |                                             |                                   |
| context-navigator-view-spinner-frames            | list of strings | ⠋…⠏     | Frames for the loading spinner                             | sidebar/context-navigator-view.el |                                             |                                   |
| context-navigator-view-spinner-interval          | number          | 0.1     | Spinner animation interval (s)                             | sidebar/context-navigator-view.el |                                             |                                   |
| context-navigator-view-spinner-degrade-threshold | number          | 0.25    | Degrade to static indicator if timer slips beyond this (s) | sidebar/context-navigator-view.el |                                             |                                   |

** Render (context-navigator-render.el)

| Variable                                 | Type         | Default | Description                       | Module/File                        |      |                                 |                                    |
|------------------------------------------+--------------+---------+-----------------------------------+------------------------------------+------+---------------------------------+------------------------------------|
| context-navigator-render-show-path       | boolean      | nil     | Show item path in right column    | render/context-navigator-render.el |      |                                 |                                    |
| context-navigator-render-truncate-name   | integer      | 64      | Max display length for item names | render/context-navigator-render.el |      |                                 |                                    |
| context-navigator-render-indicator-style | choice (auto | icons   | text                              | off)                               | text | GPTel presence indicators style | render/context-navigator-render.el |

** Icons (context-navigator-icons.el)

| Variable                                   | Type    | Default | Description                                   | Module/File                     |
|--------------------------------------------+---------+---------+-----------------------------------------------+----------------------------------|
| context-navigator-enable-icons             | boolean | t       | Enable icons in the sidebar                   | icons/context-navigator-icons.el |
| context-navigator-icons-disable-on-remote  | boolean | t       | Disable icons on remote/TRAMP                 | icons/context-navigator-icons.el |

** Project detection (context-navigator-project.el)

| Variable                                     | Type          | Default                                 | Description                                                      | Module/File                          |
|----------------------------------------------+---------------+-----------------------------------------+------------------------------------------------------------------+--------------------------------------|
| context-navigator-project-nonfile-modes      | list of modes | (gptel-mode comint-mode … dired-mode …) | Non‑file modes that can represent real project context           | project/context-navigator-project.el |
| context-navigator-project-stick-to-last-root | boolean       | t                                       | Stick to last known root instead of transient switches to global | project/context-navigator-project.el |

** Path add / masks (context-navigator-path-add.el)

| Variable                                     | Type            | Default                          | Description                                     | Module/File                            |                                               |                                        |
|----------------------------------------------+-----------------+----------------------------------+-------------------------------------------------+----------------------------------------+-----------------------------------------------+----------------------------------------|
| context-navigator-path-add-limit             | integer         | 50                               | Max files to add in a single operation          | path-add/context-navigator-path-add.el |                                               |                                        |
| context-navigator-path-add-index-cache-ttl   | number          | 30.0                             | TTL (s) for project file index cache            | path-add/context-navigator-path-add.el |                                               |                                        |
| context-navigator-path-add-case-sensitive    | choice (auto    | on                               | off)                                            | on                                     | Case sensitivity policy for basename matching | path-add/context-navigator-path-add.el |
| context-navigator-path-add-ignore-gitignored | boolean         | t                                | Prefer sources that respect .gitignore          | path-add/context-navigator-path-add.el |                                               |                                        |
| context-navigator-path-add-exclude-dotdirs   | boolean         | t                                | Exclude dot-directories in fallback recursion   | path-add/context-navigator-path-add.el |                                               |                                        |
| context-navigator-path-add-fallback-exclude  | list of strings | (node_modules dist build target) | Directory names excluded in fallback recursion  | path-add/context-navigator-path-add.el |                                               |                                        |
| context-navigator-mask-include-dotfiles      | boolean         | nil                              | Include dotfiles without explicit dot component | path-add/context-navigator-path-add.el |                                               |                                        |
| context-navigator-mask-enable-remote         | boolean         | nil                              | Allow TRAMP mask expansion                      | path-add/context-navigator-path-add.el |                                               |                                        |
| context-navigator-mask-globstar              | boolean         | t                                | Enable ** (globstar)                            | path-add/context-navigator-path-add.el |                                               |                                        |

** Transient add (max file size) (context-navigator-transient.el)

| Variable                          | Type    | Default          | Description                                      | Module/File                             |
|-----------------------------------+---------+------------------+--------------------------------------------------+------------------------------------------|
| context-navigator-max-file-size   | integer | (* 2 1024 1024)  | Max file size (bytes) for recursive adds/filters | transient/context-navigator-transient.el |

** Logging (context-navigator-log.el)

| Variable                               | Type                                  | Default                         | Description                                         | Module/File                     |
|----------------------------------------+---------------------------------------+---------------------------------+-----------------------------------------------------+----------------------------------|
| context-navigator-log-enabled          | boolean                               | nil                             | Enable logging                                      | log/context-navigator-log.el    |
| context-navigator-log-level            | choice (:error :warn :info :debug :trace) | :info                        | Minimal level to log when enabled                   | log/context-navigator-log.el    |
| context-navigator-log-auto-open-on-error | boolean                             | t                               | Open log buffer automatically on errors             | log/context-navigator-log.el    |
| context-navigator-log-buffer-name      | string                                | "*Context Navigator Log*"       | Log buffer name                                     | log/context-navigator-log.el    |
| context-navigator-log-max-lines        | integer                               | 5000                            | Trim log to at most N lines                         | log/context-navigator-log.el    |
| context-navigator-log-truncate-length  | integer                               | 800                             | Truncate long messages (0/nil = no truncation)      | log/context-navigator-log.el    |
| context-navigator-log-file-enable      | boolean                               | nil                             | Also append each line to a persistent file          | log/context-navigator-log.el    |
| context-navigator-log-file             | file or nil                           | nil                             | Path to persistent log file                         | log/context-navigator-log.el    |

** I18n (context-navigator-i18n.el)

| Variable                      | Type                        | Default | Description                                      | Module/File                        |
|-------------------------------+-----------------------------+---------+--------------------------------------------------+-------------------------------------|
| context-navigator-language    | choice (auto en ru fr de es)| auto    | UI language; auto detects from locale            | i18n/context-navigator-i18n.el      |

* Configuration examples

- Minimal setup
#+begin_src emacs-lisp
(use-package context-navigator
  :init
  (setq context-navigator-global-key "C-c n")   ;; or nil if you prefer M-x
  (setq context-navigator-autoload t
        context-navigator-autosave t)
  :config
  (context-navigator-mode 1))
#+end_src

- Advanced setup (icons, indicators, widths, counters, auto‑project, language)
#+begin_src emacs-lisp
(use-package context-navigator
  ;; :straight (context-navigator :type git :host github :repo "11111000000/context-navigator")
  :custom
  ;; Basics
  (context-navigator-global-key "C-c n")
  (context-navigator-autoload t)
  (context-navigator-autosave t)
  (context-navigator-view-width 36)

  ;; Sidebar & render
  (context-navigator-controls-style 'icons)
  (context-navigator-highlight-active-group t)
  (context-navigator-openable-count-ttl 0.3)
  (context-navigator-openable-soft-cap 120)
  (context-navigator-openable-remote-mode 'lazy)
  (context-navigator-render-indicator-style 'icons)
  (context-navigator-render-show-path t)

  ;; Icons
  (context-navigator-enable-icons t)
  (context-navigator-icons-disable-on-remote t)

  ;; Project switching & persistence
  (context-navigator-context-switch-interval 0.7)
  (context-navigator-create-default-group-file t)

  ;; GPTel apply (optional deferred mode)
  ;; (context-navigator-gptel-require-visible-window t)

  ;; Language
  (context-navigator-language 'auto)

  ;; Stability with sidebar
  (context-navigator-protect-sidebar-windows t)

  :config
  (context-navigator-mode 1))
#+end_src

* GPTel integration (one‑way)

- Navigator never imports from GPTel. It only pushes when you ask (Push now) or when auto‑push is ON.
- On push, Navigator resets GPTel context and adds all enabled items (files, buffers, selections).
- Indicators (green/gray) show binary membership in GPTel next to items (when enabled).
- Selections may require a reset under certain GPTel APIs; Navigator handles this automatically.
- Background apply is batched, and can be deferred until a GPTel buffer is visible (see =context-navigator-gptel-require-visible-window=).
- Remote files: adds warn/confirm where appropriate; GPTel add functions require readable files/buffers.

How to use:
- Toggle auto‑push in the header ([→]) or via transient (G).
- Press [⇪] Push now in the footer, or P in transient, for a manual reset + add.
- Clear GPTel via footer [⌦] or transient (C).

* Persistence

- Format v3, one file per group:
  - Project: =<project>/.context/<group>.el=
  - Global: =~/.context/<group>.el=
- =state.el= tracks the current group and display names.
- Async load with batching, spinner, and progress events.
- On unreadable/broken group file, the sidebar can auto‑open the groups list (configurable via =context-navigator-auto-open-groups-on-error=).

Tips:
- The first time you open a project/global context, a default group file can be auto‑created (see =context-navigator-create-default-group-file=).
- Switching groups saves the previous group automatically and loads the new one asynchronously.

* Project detection

- Roots from =project.el= or projectile (if available).
- “Interesting” buffers:
  - File‑backed buffers
  - gptel buffers (derived modes)
  - Dired (and wdired) buffers
- Auto‑switch is throttled (see =context-navigator-context-switch-interval=) and sticky (keep last root instead of flickering to global).
- Child frames (posframe/popups) and certain internal buffers (e.g., corfu) are ignored.

Manual project switch at any time: =M-x context-navigator-switch-to-current-buffer-project= (also bound to transient “p”).

* Performance and remote paths

- “Open buffers” counter is remote‑aware:
  - off  — ignore remote files
  - lazy — do not stat TRAMP paths; consider openable if no live buffer exists
  - strict — verify existence with =file-exists-p= even over TRAMP (may be slow)
- Soft cap and TTL keep the counter responsive (see =context-navigator-openable-soft-cap= and =context-navigator-openable-count-ttl=).
- Mask/glob expansion skips TRAMP by default (enable via =context-navigator-mask-enable-remote= only if you need it).

* Troubleshooting and FAQ

- The menu/keys don’t work?
  - Ensure =context-navigator-mode= is enabled and set =context-navigator-global-key= (or call =M-x context-navigator-transient=).
- Navigator doesn’t open?
  - Try =M-x context-navigator-start= or =M-x context-navigator-open=.
- Icons are missing?
  - Install =all-the-icons= and run =M-x all-the-icons-install-fonts=, then restart Emacs.
- GPTel is not installed?
  - Navigator works fine without it. Push operations will no‑op with an informative message.
- Group load failed?
  - The sidebar can auto‑open the groups list; from there you can delete or fix the group file.
- How do I save/load/unload?
  - Save: =M-x context-navigator-context-save=. Load: =M-x context-navigator-context-load=. Unload (switch to global): =M-x context-navigator-context-unload= (also transient “X”).
- How to manage groups?
  - From the sidebar groups view: a (add), r (rename), c (duplicate), d (delete).
- How to clear GPTel or the group?
  - Footer [⌦] or transient “C” clears GPTel. Footer [✖] or “E” clears the current group.
- Open/close all context buffers?
  - Footer [O]/[∅] or sidebar keys O/o and the close command via footer.

* Contributing

Issues and pull requests are welcome. Please:
- Include clear reproduction steps and Emacs/version info in bug reports.
- Keep patches small and focused; prefer functional, side‑effect‑local changes.
- Update docstrings and this README when behavior or user‑facing options change.

* License

MIT — see [[./LICENSE][LICENSE]].

